<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trade-War ELN Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-4">Trade-War ELN Shortlist Dashboard</h1>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post" class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Min 1Y Return (%)</label>
          <input type="number" step="0.1" name="min_return" class="form-control" value="{{ config.thresholds.min_one_year_return }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Max 90d Realised Vol (%)</label>
          <input type="number" step="0.1" name="max_vol" class="form-control" value="{{ config.thresholds.max_realized_vol }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Max China Share (0-1)</label>
          <input type="number" step="0.01" name="max_china" class="form-control" value="{{ config.thresholds.max_china_share }}">
        </div>

        <div class="col-12">
          <label class="form-label">ETF Sleeves</label>
          <div class="row">
            {% for etf, desc in etf_map.items() %}
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="{{ etf }}" id="etf-{{ etf }}" name="etf_candidates" {% if etf in selected_etfs %}checked{% endif %}>
                <label class="form-check-label" for="etf-{{ etf }}">{{ etf }} â€“ {{ desc }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Weights</label>
          <div class="row g-2">
            {% for key, label in {
              'policy':'Policy',
              'china':'China',
              'returns':'Returns',
              'liquidity':'Liquidity',
              'volatility':'Volatility'
            }.items() %}
            <div class="col-md-2">
              <input type="number" step="0.01" name="weight_{{ key }}" class="form-control" value="{{ config.weights[key] }}" placeholder="{{ label }}">
              <small class="text-muted">{{ label }}</small>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Manual inclusions (one per line, format TKR:Description)</label>
          <textarea name="manual_inclusions" class="form-control" rows="3">{% for tkr, desc in config.manual_inclusions.items() %}{{ tkr }}:{{ desc }}
{% endfor %}</textarea>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-primary">Run Shortlist</button>
          <a href="{{ url_for('index') }}" class="btn btn-secondary">Reset</a>
        </div>
      </form>

      {% if table_html %}
        <div class="card">
          <div class="card-header">Shortlist Results</div>
          <div class="card-body table-responsive">
            {{ table_html | safe }}
          </div>
        </div>
      {% elif error %}
        <div class="alert alert-warning">{{ error }}</div>
      {% endif %}

      {% if overrides_json %}
        <div class="card mt-4">
          <div class="card-header">Applied Overrides</div>
          <pre class="card-body">{{ overrides_json }}</pre>
        </div>
      {% endif %}

      {% if answers %}
      <div class="mt-5">
        <h2>Interview Talking Points</h2>

        <div class="card mb-3">
          <div class="card-header">1. Filtering Criteria & Rationale</div>
          <div class="card-body">
            <p><strong>Thresholds:</strong></p>
            <ul>
              {% for line in answers.filters.thresholds %}
              <li>{{ line }}</li>
              {% endfor %}
            </ul>
            <p><strong>Pillar Weights:</strong> {{ answers.filters.weights | join(', ') }}</p>
            <p><strong>Highlighted names:</strong></p>
            <ul>
              {% for line in answers.filters.top4 %}
              <li>{{ line }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">2. Payoff Structure</div>
          <div class="card-body">
            <p>{{ answers.payoff.message }}</p>
            {% if answers.payoff.image %}
            <img class="img-fluid" alt="ELN Payoff" src="data:image/png;base64,{{ answers.payoff.image }}">
            <small class="text-muted d-block mt-2">Image sourced from outputs/payoff_profile.png</small>
            {% else %}
            <div class="alert alert-warning">Run `python3 src/eln_analysis.py` to regenerate payoff charts.</div>
            {% endif %}
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">3. Pricing Summary (Black-Scholes replication)</div>
          <div class="card-body">
            <p><strong>Note PV:</strong> {{ answers.pricing.note_price or 'N/A' }}</p>
            {% if answers.pricing.components %}
            <pre>{{ answers.pricing.components }}</pre>
            {% else %}
            <div class="alert alert-info">{{ answers.pricing.note_price }}</div>
            {% endif %}
            <p><strong>Best two candidates:</strong></p>
            <ul>
              {% for line in answers.best_two %}
              <li>{{ line }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">4. Delta Profile & Risk Commentary</div>
          <div class="card-body">
            {% if answers.delta.message %}
            <div class="alert alert-info">{{ answers.delta.message }}</div>
            {% endif %}
            {% if answers.delta.terminal %}
            <p><strong>Terminal delta:</strong> {{ answers.delta.terminal }}</p>
            {% endif %}
            {% if answers.delta.t0 %}
            <p><strong>Time-0 delta:</strong> {{ answers.delta.t0 }}</p>
            {% endif %}
            <p>Key risks: gap risk below the 80% barrier, downside skew from the short 80% call, correlation shocks between basket names, and funding considerations on the 20% ZCB.</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </body>
</html>
